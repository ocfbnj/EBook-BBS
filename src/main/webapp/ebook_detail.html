<!DOCTYPE html>
<html lang="zh-CN" class="ua-windows ua-chrome ua-chrome87 ua-webkit is-anonymous ">

<head>
    <meta charset="utf-8">

    <title id="title">小风暴1.0 - 肖茉莉 </title>

    <link rel="stylesheet" href="css/innerother.css">
    <link rel="stylesheet" href="css/inner.css">
    <link rel="stylesheet" href="css/innerLay.css">

    <script src="js/jquery-3.5.1.js"></script>
    <script src="js/include.js"></script>
    <script src="js/getParameter.js"></script>
</head>

<body>
<div class="wrapper">
    <div id="react-root"></div>
    <!--页面头部-->
    <div id="header"></div>

    <!--页面主体-->
    <div class="main" itemscope="" itemtype="http://schema.org/Book" itemprop="mainEntity" style="margin-top: 10px;">
        <div class="col col9 app-article">
            <div class="article-profile-section article-profile-primary ">
                <!--图书封面-->
                <div class="cover shadow-cover">
                    <img height="209px" id="book_cover" src="img/1.jpg" width="140px"
                         alt="小风暴1.0" itemprop="image">
                </div>
                <!--图书描述-->
                <div class="article-profile-bd">
                    <h1 class="article-title" id="book_title" itemprop="name">小风暴1.0</h1>
                    <div class="article-meta" style="margin-top: 20px">
                        <p class="author"><span class="label">作者</span>
                            <span class="labeled-text">
                                <a class="author-item" id="book_author"
                                   href="/search?q=%E8%82%96%E8%8C%89%E8%8E%89">肖茉莉</a>
                            </span>
                        </p>
                        <p class="category">
                            <span class="label">类别</span>
                            <span class="labeled-text"> </span>
                            <span id="book_classify" temprop="genre"> 出版 / 虚构 </span>
                        </p>
                        <p class=""><span class="label">出版社</span><span class="labeled-text"><span>中信出版社</span>&nbsp;/&nbsp;<span>2016-08</span></span>
                        </p>
                    </div>

                    <!--TODO: 下载点击事件触发-->
                    <!--下载点击事件触发-->
                    <div class="book-rating">
                        <span class="score">下载量：</span>
                        <span class="amount">353 次</span>
                        <span class="labeled-text" style="margin-left: 20px">
                                <a class="download"
                                   href="">点击下载</a>
                        </span>
                    </div>

                    <!--TODO: 阅读点击事件触发-->
                    <!--阅读点击事件触发-->
                    <div class="profile-reading-actions ebook-profile">
                        <a href="" target="_blank" data-variant="rect" data-size="l"
                           class="btn btn-read "><span class="btn-text">开始阅读</span></a>
                    </div>
                </div>
            </div>

            <!--作品简介-->
            <section class="article-profile-section">

                <!--作品简介-->
                <section class="article-profile-intro collapse-context">
                    <div class="hd">
                        <h3>作品简介</h3>
                    </div>
                    <div data-line-height="24" data-max-lines="3" id="mask" itemprop="description"
                         style="max-height: 71px;"
                         class="bd abstract-full collapse-content">
                        <div class="info" id="book_intro">
                            <p>献给青春，献给你！</p>
                            <p>一部本土创投、金融精英的成长爱恨、职场奋斗史！</p>
                            <p>本书在大时代的背景下，以金融才子高山、创投猎手秦沃为两条主线，情节围绕外交人才许信、律师木心喜、创业者谷东等年轻人的职场、创业、爱恨情仇展开。</p>
                        </div>
                    </div>
                    <div class="expand-collapsed-content">
                        <a data-action="expand" href="javascript:void(0)" id="expand">展开全部</a>
                    </div>
                </section>

                <!--评论板块-->
                <div id="comment-root">
                    <div class="mixed-comment-list ebook-page">
                        <ul class="comment-list">
                            <div class="section-hd">
                                <h3>
                                    评论
                                    <span id="comment_count">8</span>
                                </h3>
                            </div>

                            <!--单评论模块 -->
                            <li class="comment-item" id="comments">
                                <div class="inner">
                                    <!--用户信息 -->
                                    <div class="comment-item-header">
                                        <a class="lnk-avatar" href=""
                                           target="_self">
                                            <div class="avatar avatar40 ">
                                                <div class="inner" style="width: 40px; height: 40px; border-radius: 40px;margin-right: 8px;
                                                background-image: url(img/user_normal.jpg); background-position: center center;
                                                background-size: cover;">
                                                </div>
                                            </div>
                                        </a>
                                        <!--用户姓名 -->
                                        <div class="comment-user-info">
                                            <div>
                                                <a class="comment-username"
                                                   href="" target="_self">
                                                    蓝蓝与鱼
                                                </a>
                                            </div>

                                            <!--发布评论时间-->
                                            <div>
                                                <a href="">
                                                    <span class="create-time">12-19</span>
                                                    <span>发表书评</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <!--评论文本内容-->
                                    <div class="comment-content">
                                        <p><span class="Linkify">年代感好强，看的我觉得很尴尬</span></p>
                                    </div>
                                    <!--按键模块-->
                                    <div class="comment-actions">
                                        <div class="inner">
                                            <div class="action-group">
                                                <!--点赞按钮-->
                                                <a href="#" class="btn-contained btn-upvote require-login"
                                                   data-size="s">
                                                    <span class="count">0</span>
                                                </a>
                                                <!--回复按钮-->
                                                <a class="btn-contained btn-comment" href="" data-size="s">
                                                    <span class="count">0</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <a class="lnk-more" href="javascript:void(0)" id="more_comment"></a>
                        <div class="comment-content">
                            <div style="font-size: larger;">发布评论</div>
                            <textarea id="content" id="comment-text" style="width: 100%;height:90px;"></textarea>
                            <button class="btn-contained btn-comment" id="btn-comment"
                                    style="float: right;margin-top: 8px;">发表
                            </button>

                        </div>

                    </div>

                </div>

                <!--书评模块-->
                <div class="article-profile-intro article-reviews-section reviews">
                    <section class="section-book-reviews-list tabs-container">
                        <div class="reviews-heading" style="margin-bottom: 12px">
                            <h3 class="reviews-heading-title">来自豆瓣读书的评论</h3>
                        </div>

                        <div class="book-review-lists">
                            <div class="book-review-list tab-panel">
                                <ul class="book-reviews review-list">
                                    <!-- 单个书评内容-->
                                    <li itemprop="review" itemscope="itemscope"
                                        class="review-item collapsed col-media">
                                        <!-- 用户头像-->
                                        <div class="avatar cm-left">
                                            <a href="" target="_blank" class="pic">
                                                <img src="img/u16290.jpg" alt="人间四月">
                                            </a>
                                        </div>
                                        <div class="info cm-body">

                                            <div itemprop="author" class="author" style="margin-left: 8px">
                                                <a href="" target="_blank">人间四月</a>
                                            </div>
                                            <div itemprop="reviewBody" class="desc" style="margin-left: 12px">
                                                金融出身的作者本身给这本书的职场内容增添了很多可靠而且有趣的内容。这些职场上摸爬滚打的经验是外行人光靠百度查资料难以想象到的。
                                                以女性视角来写的职场文不算少，...
                                            </div>
                                            <!--发布时间-->
                                            <div class="impression" style="margin-left: 8px">
                                                <a href=""
                                                   target="_blank" class="date">2017-10-27</a>
                                            </div>

                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </div>

                <!--划线模块-->
                <section class="article-profile-intro popular-annotations">
                    <div class="hd">
                        <h3>热门划线</h3>
                    </div>
                    <div class="bd">
                        <ol>
                            <li>
                                <blockquote>
                                    <a href="" target="_blank">
                                        但纪伯伦先生在《先知》里的一段话让我记忆深刻：“你的儿女，其实不是你的儿女，他们是生命对于自身渴望而诞生的孩子。他们借助你来到这个世界，却非因你而来。”
                                    </a>
                                </blockquote>
                            </li>
                            <li>
                                <blockquote>
                                    <a href="" target="_blank">
                                        在大时代里，应该相遇的人终将会相遇
                                    </a>
                                </blockquote>
                            </li>
                            <li>
                                <blockquote>
                                    <a href="" target="_blank">
                                        “商场上的二八法则：一般而论，企业20%的核心客户会带来80%的利润；
                                        同理，最核心的20%的时间会给你的职场带来80%的收获；20%的职场人脉也会给你带来80%的收益。
                                        所以，空闲之余，多花点时间甄选20%的职场人脉，并且经营好这些职场人脉，你走向职场达人的道路就会更顺当一点。
                                        无疑，华尔街的犹太圈子就是那20%的精华人脉。”
                                    </a>
                                </blockquote>
                            </li>
                            <li>
                                <blockquote>
                                    <a href="" target="_blank">
                                        但两三年后可能这个力量就更明显和强大了，这种模式值得期待
                                    </a>
                                </blockquote>
                            </li>
                        </ol>
                    </div>
                </section>
            </section>
        </div>

        <!--侧边栏-出版模块-->
        <div class="col col4">
            <section>
                <div class="hd author-heading">
                    <h3>出版方</h3>
                </div>
                <div class="bd">
                    <div class="author-info collapse-context">
                        <h4>
                            <a href="/provider/6578125/" target="_blank"><img src="img/ownImg.png" alt="中信出版社"
                                                                              class="avatar"><span
                                    class="name">中信出版社</span></a>
                        </h4>
                        <div data-max-lines="6" data-line-height="21.6" class="collapse-content intro">
                            <p class="intro">
                                我们满怀激情，关注思想、关注理念、关注人物、关注资讯、关注时尚，为读者提供最前沿的思想与最优秀的学习实践，通过有价值的、有享受的阅读，倡导与展示新的文化主流，启动一个“大众阅读时代”。</p>
                        </div>
                    </div>
                    <div class="author-other-works">
                        <div class="title">全部作品
                            <a href="" target="_blank">3853</a>）
                        </div>
                        <ul class="works-list">
                            <li><a target="_blank" href="">无人旁观时我们是谁</a></li>
                            <li><a target="_blank" href="">心战：深度解析围棋顶尖棋手的巅峰对决</a></li>
                            <li><a target="_blank" href="">会好的：悲观者常常正确，乐观者往往成功</a></li>
                            <li><a target="_blank" href="">投资的准则（套装共3册）</a></li>
                            <li><a target="_blank" href="">学会投资：中信投资经典系列（套装10册）</a></li>
                        </ul>
                    </div>
                </div>
            </section>

            <section>
                <div class="hd tags-heading">
                    <h3>作品标签</h3>
                </div>
                <div class="bd">
                    <meta itemprop="keywords" content="小说,爱情,商业,职场,投资,限时特价">
                    <ul class="tags">
                        <li>
                            <a href=""><span class="tag-name">小说</span></a>
                        </li>
                        <li>
                            <a href=""><span class="tag-name">人文社科</span></a>
                        </li>
                        <li>
                            <a href=""><span class="tag-name">计算机互联网</span></a>
                        </li>
                        <li>
                            <a href=""><span class="tag-name">漫画绘本</span></a>
                        </li>

                    </ul>
                </div>
            </section>
        </div>


        <script type="text/template" id="tmpl-countdown-tip">
            <h4 class="success-sign">{{- title }}</h4>
            <p class="count-down-tip"><span class="count-down-num">{{- sec }}</span>秒钟后自动关闭</p>
        </script>

        <script>
            var Ark = Ark || {}
            Ark.showPreviewToast = false
        </script>

        <script src="js/vendor.js"></script>

        <script src="js/common.js"></script>
        <script src="js/app.js"></script>

    </div>
</div>

<script>
    const max_show_comment = 5;
    let comm = $("#comments");
    comm.html("");

    function append_comment(comment) {
        let content = comment["content"];
        let date = comment["date"];
        let username = comment["username"];

        content = content.replace("\n", "<br/>");
        let html = comm.html() + `
    <div class="inner">
        <div class="comment-item-header">
            <a class="lnk-avatar" href=""
               target="_self">
                <div class="avatar avatar40 ">
                    <div class="inner" style="width: 40px; height: 40px; border-radius: 40px;margin-right: 8px;
                    background-image: url(img/user_normal.jpg); background-position: center center;
                    background-size: cover;">
                    </div>
                </div>
            </a>
            <div class="comment-user-info">
                <div>
                    <a class="comment-username"
                       href="" target="_self">
                        ` + username + `
                    </a>
                </div>
                <div>
                    <a href="">
                        <span class="create-time">
                            ` + date + `
                        </span>
                        <span>发表书评</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="comment-content">
            <p><span class="Linkify">
                ` + content + `
            </span></p>
        </div>
        <div class="comment-actions">
            <div class="inner">
                <div class="action-group">
                    <a href="#" class="btn-contained btn-upvote require-login"
                       data-size="s">
                        <span class="count">0</span>
                    </a>
                    <a class="btn-contained btn-comment" href="" data-size="s">
                        <span class="count">0</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    `;
        comm.html(html);
    }

    function load(bid) {
        let data = {"bid": bid};

        // 获得图书详情
        $.get("/ebook/getBook", data, function (book) {
            // 修改标题
            $("#title").html(book.title);

            // 修改图书信息
            $("#book_title").html(book.title);
            $("#book_cover").attr("src", book.cover_path);
            $("#book_cover").attr("alt", book.title);
            $("#book_author").html(book.author.length ? book.author : "未知");
            $("#book_classify").html(book.classify)

            // 修改简介
            let intro = $("#book_intro");
            let intro_html = "";

            let paragraphs = book.intro.split("\n");
            for (const paragraph of paragraphs) {
                if (paragraph.length) {
                    intro_html += `<p>` + paragraph + `</p>`;
                }
            }

            intro.html(intro_html);
        });

        // 获得评论
        $.get("/ebook/getComments", data, function (comments) {
            console.log(comments);

            // 填充评论数
            $("#comment_count").html(comments.length)

            // 填充评论
            // 每次最多显示@max_show_comment个
            let i = 0;
            for (; i !== max_show_comment; i++) {
                let comment = comments[i];
                append_comment(comment);
            }

            if (i === max_show_comment) {
                let remain = comments.length - max_show_comment;
                let more_comment = $("#more_comment");

                more_comment.html("更多评论 " + remain);

                more_comment.click(function () {
                    more_comment.html("");

                    for (let i = max_show_comment; i !== comments.length; i++) {
                        append_comment(comments[i]);
                    }
                });
            }
        });
    }

    $(function () {
        const bid = getParameter("bid");
        load(bid);

        $("#btn-comment").click(function () {
            // 检查是否登录
            $.get("/user/getUser", {}, function (user) {
                console.log(user);
                let res = check($("#content").val());
                if (user == null) {
                    // 跳转到登录注册界面
                    location = "/loginRegister.html";
                } else if (res === "") {
                    //发送内容为空

                } else {
                    // 发表评论
                    let data = {
                        "bid": bid,
                        "uid": user["userID"],
                        "content": $("#content").val()
                    };

                    $.post("/ebook/addComment", data, function (res) {
                        if (res.flag) {
                            location.reload();
                        } else {
                            // TODO 评论失败
                        }
                    });
                }
            });
        });

        // 更多介绍
        $("#expand").click(function () {
            $("#expand").parent().html("");
            $("#mask").css("max-height", "");
        });
    });
</script>
<script>
    function check(chara) {
        let txt = "";
        let flag = 0;
        let i = 0;

        while (((chara[i] === '\n') | (chara[i] === " ") && (i < chara.length)))
            i++;

        for (i; i < chara.length; i++) {
            if (chara[i] !== ' ' | flag === 0) txt += chara[i];
            if (chara[i] === ' ' && flag === 0)
                flag = 1;
            else
                flag = 0;
        }
        return txt;
    }
</script>

</body>
